# 后继：rfc5389 (STUN-Session Traversal Utilities for NAT)

# STUN - 网络地址转换器(NAT)下用户数据报文协议的简单穿透


## 概述
网络地址转换器(NAT)下用户数据报文协议的简单穿透(STUN)是一个轻量级的协议，它用来使得应用程序发现它们与公共因特网间NAT、防火墙设备的存在及类型。它还为应用程序提供能力来获知NAT设备为应用程序分配的公共因特网协议(IP)地址。STUN工作于现有的NAT设备上，且无需这些设备的任何行为。总而言之，它可以使得许多应用程序工作在现有的NAT基础设施上。

## 内容
1. 适用范围
2. 简介
3. 术语
4. 定义
5. NAT变种
6. 大致运转流程
7. 大致的消息
8. 服务端行为
8.1. 绑定请求
8.2. 公用会话密钥请求
9. 客户端行为
9.1. 发现
9.2. 获取一个公用会话密钥
9.3. 构建绑定请求
9.4. 处理绑定响应
10. 使用案例
10.1. 发现处理
10.2. 发现绑定生命周期
10.3. 获取绑定
11. 协议细节
11.1. 消息头
11.2. 消息属性
11.2.1. MAPPED-ADDRESS
11.2.2. RESPONSE-ADDRESS
11.2.3. CHANGED-ADDRESS
11.2.4. CHANGE-REQUEST
11.2.5. SOURCE-ADDRESS
11.2.6. USERNAME
11.2.7. PASSWORD
11.2.8. MESSAGE-INTEGRITY
11.2.9. ERROR-CODE
11.2.10. UNKNOWN-ATTRIBUTES
11.2.11. REFLECTED-FROM
12. 安全考量
13. IANA考量
14. IAB考量
15. 致谢
16. 标准引用
17. 参考引用
18. 作者地址
19. 版权声明

## 1. 适用性声明
这个协议并不涉及到有关NAT的一切问题。它不能使得外来TCP连接请求穿过NAT。它使得外来UDP数据包穿过NAT，但只是一部分现有的NAT类型。尤其是对称NAT(在大型企业中很普遍，后面有定义)，STUN并不能使得UDP数据包穿过它。STUN的发现过程基于NAT对于UDP数据包的处理，这种假设在新的NAT设备部署后可能将不成立。当一个端点想获取同一NAT下其他的端点通信地址时，这种情况下STUN也不能工作。当STUN服务端不在一个公共共享地址区域时STUN也不能工作。对于STUN更详细的限制，请参阅第14节。

## 2. 引言
网络地址转换器(NATs)在提供了很多好处的同时也带来了很多弊病。这些弊病中最麻烦的地方在于它破坏了很多现存的IP应用，并且使得部署新的这些应用愈加困难。已经有很多准则用来指导如何构建NAT友好的协议，但很多协议并不能简单地依据这些准则进行构建，包括几乎所有的点对点(peer-to-peer)协议(多媒体通讯、文件分享以及游戏)。

为了解决这个问题，应用层网关(Application Layer Gateways - ALGs)被嵌入到NAT中。ALGs为特定协议执行穿透NAT所需的应用层功能。通常这需要重写应用层的消息以包含转换过的地址，而不是消息发送者插入的地址。ALGs有诸多限制，包括可扩展性、可靠性以及新应用的部署速度。为了解决这些问题，Middlebox Communications(MIDCOM)协议被开发出来。MIDCOM使得一个应用实体，比如一个客户终端或者某些网络伺服器(好比如一个Session Initiation Protocol(SIP)代理)得以控制NAT(或者防火墙)从而获得NAT绑定并打开或者关闭一个穿透孔(pinholes)。通过使用MIDCOM，NATs和应用可以解耦，NATs也不需要将ALGs嵌入进来，解决了现有架构所引入的限制。

不幸的是MIDCOM需要对现有NAT和防火墙以及应用组件进行升级。完全升级这些NAT和防火墙产品需要很长的时间。部分原因在于NAT和防火墙的部署者并不一定就是应用的部署或者使用者。于是很多情况下升级这些设备的动机并不强烈。设想一下，一个机场互联网休息室通过NAT提供网络服务。一个连接到这个NAT网络的用户想要使用点对点服务，但很遗憾的是他并不能，因为NAT设备不支持点对点服务。然而休息室的管理员并不是这个服务的提供者，他们没有动力去升级NAT设备以支持上述服务，不管是用ALG或者MIDCOM。

另一个问题是MIDCOM协议需要控制middleboxes的代理知晓这些middleboxes的身份并且和这些允许控制的middleboxes有一种关系。在很多配置下，这是不可能的。例如，很多有线网提供商在他们整个访问网络的前端使用NAT。这个NAT可能是最终用户购买并且可操作的住宅内NAT的附加。有线访问网络内的最终用户可能没有这个NAT的控制权，甚至根本不知其存在。

现今很多私有协议，比如线上游戏的(比如RFC 3027中描述的)以及网络电话的(Voice over IP)，都开发出了一些技巧使得它们可以通过NATs工作并且不改变那些NATs。这份文档即从这些协议吸收一些想法并尝试将它们编纂成典籍构造出一种可以满足很多应用的互操作性协议。

此文档所描述的STUN协议，使得NAT的实体首先发现NAT的存在与否以及NAT的类型，然后了解NAT分配的绑定地址。STUN不需要对NAT有所更改，并且可以工作于应用实体与公共因特网串联有任意层NATs的情况。

## 3. 术语
在本文档中，关键词"MUST"、"MUST NOT"、"REQUIRED"、"SHALL"、"SHALL NOT"、"SHOULD"、"SHOULD NOT"、"RECOMMENTED"、"MAY"、以及"OPTIONAL"如BCP 14、RFC 2119所描述一般并标明了STUN实现所需遵循的需求等级。

## 4. 定义
STUN客户端：一个STUN客户端(也简称为客户端)是生成STUN请求的实体。一个STUN客户端可以运行在一个终端系统上，比如用户的PC，或者可以运行在一个网络元素上，比如一个会议伺服器。

STUN服务器：一个STUN伺服器(也简称为伺服器)是接收STUN请求并且发送STUN响应的实体。STUN伺服器通常部署在公共因特网。

## 5. NAT变种
我们假设本文档的读者对NATs是有所耳闻的。现今观察到NAT对UDP的处理依实现是不同的。已观察到的四种处理的实现如下：

完全锥形(Full Cone)：一个完全锥形NAT对于同一内部IP和端口发出的请求会映射到同一外部IP和端口。更甚者，任何外部主机皆可通过外部映射地址发送一个包给内部主机。

限制锥形(Restricted Cone)：一个限制锥形NAT对于同一内部IP和端口发出的请求会映射到同一外部IP和端口。但与完全锥形NAT不同的是，只有当内部主机发送过包给外部主机X，主机X才能通过映射地址向内部主机发送数据包。

端口限制锥形(Port Restricted Cone)：
